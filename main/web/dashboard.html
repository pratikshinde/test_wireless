<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRa Mesh - Dashboard</title>
    <link rel="stylesheet" href="/styles.css">

</head>

<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 3L3 21v-2l16-16h2zm-4 4l-4 4 1.41 1.41 4-4L17 7zm-4 4l-4 4 1.41 1.41 4-4L13 11z" />
                </svg>
                <span>LoRa Mesh Network</span>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link active"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 4a9 9 0 0 1 9 9h-2a7 7 0 0 0-7-7 7 7 0 0 0-7 7H3a9 9 0 0 1 9-9zm0 5l2 5-2 1-2-1 2-5z" />
                    </svg> Dashboard</a>
                <a href="/lora-config.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                        height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                    </svg> LoRa Config</a>
                <a href="/devices.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M20 16h-4v-2.07l-2.9-2.9C15.5 10.3 17 8.35 17 6c0-2.76-2.24-5-5-5S7 3.24 7 6c0 2.35 1.5 4.3 3.9 5.03l-2.9 2.9V16H4c-1.1 0-2 .9-2 2v4h4v-2h2v2h4v-2h2v2h4v-2h2v2h4v-4c0-1.1-.9-2-2-2zm-8-9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" />
                    </svg> Devices</a>
            </div>
            <div class="nav-status">
                <span class="status-indicator online"></span>
                <span>Node <span id="nodeId">...</span></span>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="dashboard">
            <!-- Network Overview -->
            <div class="card full-width">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                    </svg> Network Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4CAF50;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M5 18c0 .55.45 1 1 1h1V4H6c-.55 0-1 .45-1 1v13zM18 4h-1v15h1c.55 0 1-.45 1-1V5c0-.55-.45-1-1-1zM9 19h1V4H9v15zm5 0h1V4h-1v15z" />
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="nodeCount">1</h3>
                            <p>Online Nodes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #2196F3;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path d="M2 22h20V2z" />
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="avgRssi">0</h3>
                            <p>Avg RSSI (dBm)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FF9800;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M19 15.18V7c0-2.21-1.79-4-4-4s-4 1.79-4 4v10c0 2.21-1.79 4-4 4s-4-1.79-4-4V5.82h2V17c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1.9-2 2-2s2 .9 2 2v8.18h2z" />
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="routeCount">0</h3>
                            <p>Active Routes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #9C27B0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="uptime">0</h3>
                            <p>Uptime (hours)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path
                            d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
                    </svg> Recent Activity</h2>
                <div class="activity-list" id="activityList">

                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path
                            d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.3c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z" />
                    </svg> Quick Actions</h2>
                <div class="action-grid">
                    <button class="action-btn" onclick="sendPing()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M22 6h-7c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h7c.55 0 1-.45 1-1V7c0-.55-.45-1-1-1zm-9 10h-2v4H9v-4H2V8h7V4h2v12z" />
                        </svg>
                        <span>Send Ping</span>
                    </button>
                    <button class="action-btn" onclick="discoverNodes()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                        <span>Discover Nodes</span>
                    </button>
                    <button class="action-btn" onclick="refreshNetwork()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" />
                        </svg>
                        <span>Refresh Network</span>
                    </button>
                    <button class="action-btn" onclick="showConfig()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                        </svg>
                        <span>Quick Config</span>
                    </button>
                </div>
            </div>

            <!-- Network Health -->
            <div class="card full-width">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path
                            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35zM11 7h2v5.5l2 1.2.9-1.8L12 7z" />
                    </svg> Network Health</h2>
                <div class="health-grid">
                    <div class="health-item">
                        <h3>Connectivity</h3>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 0%"></div>
                        </div>
                        <span>--</span>
                    </div>
                    <div class="health-item">
                        <h3>Signal Quality</h3>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 0%"></div>
                        </div>
                        <span>--</span>
                    </div>
                    <div class="health-item">
                        <h3>Route Stability</h3>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 0%"></div>
                        </div>
                        <span>--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/script.js?v=2"></script>
    <script>
        // Inline fallback to ensure Node ID updates even if script.js is cached
        fetch('/api/config')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data.node_id && document.getElementById('nodeId')) {
                    document.getElementById('nodeId').textContent = data.data.node_id;
                }
            })
            .catch(e => console.log('Inline ID fetch failed', e));

        // Dashboard specific functions
        async function updateDashboard() {
            try {
                // Update node count
                const nodesRes = await fetch('/api/nodes');
                const nodes = await nodesRes.json();
                document.getElementById('nodeCount').textContent = nodes.length;

                // Calculate average RSSI
                let totalRssi = 0;
                let count = 0;
                nodes.forEach(node => {
                    if (node.online && node.rssi !== 0) {
                        totalRssi += node.rssi;
                        count++;
                    }
                });
                document.getElementById('avgRssi').textContent = count > 0 ? Math.round(totalRssi / count) : 0;

                // Update route count
                const routesRes = await fetch('/api/routes');
                const routes = await routesRes.json();
                let activeRoutes = routes.filter(route => route.active).length;
                document.getElementById('routeCount').textContent = activeRoutes;

                // Update uptime (example)
                document.getElementById('uptime').textContent = "24";

            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function sendPing() {
            fetch('/api/ping', { method: 'POST' })
                .then(response => {
                    addActivity('Sent ping to all nodes', 'tx');
                })
                .catch(error => {
                    console.error('Error sending ping:', error);
                });
        }

        function discoverNodes() {
            fetch('/api/discover', { method: 'POST' })
                .then(response => {
                    addActivity('Initiating node discovery', 'tx');
                })
                .catch(error => {
                    console.error('Error discovering nodes:', error);
                });
        }

        function refreshNetwork() {
            updateDashboard();
            addActivity('Network data refreshed', 'info');
        }

        function showConfig() {
            window.location.href = '/config';
        }

        function addActivity(message, type) {
            const activityList = document.getElementById('activityList');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';

            const iconName = type === 'tx' ? 'paper_plane' :
                type === 'rx' ? 'broadcast_tower' :
                    'info_circle';
            const iconColor = type === 'tx' ? 'tx' :
                type === 'rx' ? 'rx' : 'info';

            activityItem.innerHTML = `
                <div class="activity-icon ${iconColor}">
                    ${getIcon(iconName)}
                </div>
                <div class="activity-details">
                    <p>${message}</p>
                    <span class="activity-time">Just now</span>
                </div>
            `;

            activityList.prepend(activityItem);

            // Keep only last 10 activities
            while (activityList.children.length > 10) {
                activityList.removeChild(activityList.lastChild);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            updateDashboard();
            // Update every 10 seconds
            setInterval(updateDashboard, 10000);
        });
    </script>
</body>

</html>